<!DOCTYPE html>
<html>
<head>
  <title>Medical History Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase SDK v9 (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDVZNBKutvRFrQOFQunVgSBwJFLMvrct0Q",
      authDomain: "aayuh-c9a87.firebaseapp.com",
      projectId: "aayuh-c9a87",
      storageBucket: "aayuh-c9a87.firebasestorage.app",
      messagingSenderId: "459370049467",
      appId: "1:459370049467:web:4354a11c6b43d3f6dede9e",
      measurementId: "G-GNFKCBES0L"
    };

    // ‚úÖ Init Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const userId = "USER_UID_FROM_DASHBOARD"; // Replace with logged-in userId

    // ‚úÖ Upload Report
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("uploadBtn").addEventListener("click", uploadReport);
      document.getElementById("applyFiltersBtn").addEventListener("click", loadReports);
      document.getElementById("clearFiltersBtn").addEventListener("click", clearFilters);
      loadReports();
    });

    async function uploadReport() {
      const title = document.getElementById('title').value;
      const description = document.getElementById('description').value;
      const doctor = document.getElementById('doctor').value;
      const date = document.getElementById('reportDate').value;
      const file = document.getElementById('fileInput').files[0];

      if (!title || !description || !doctor || !date || !file) {
        alert("‚ö†Ô∏è Please fill all fields and choose a file.");
        return;
      }

      try {
        const fileType = file.type.includes("pdf") ? "pdf" : "image";
        const filePath = `reports/${userId}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, filePath);

        await uploadBytes(storageRef, file);
        const fileURL = await getDownloadURL(storageRef);

        await addDoc(collection(db, "medicalReports"), {
          title, description, doctor, date,
          fileURL, fileType, userId,
          timestamp: Date.now()
        });

        alert("‚úÖ Report uploaded successfully!");
        loadReports();
      } catch (error) {
        console.error("Upload failed:", error);
        alert("‚ùå Upload failed: " + error.message);
      }
    }

    // ‚úÖ Load Reports with filters
    async function loadReports() {
      const reportList = document.getElementById('reportList');
      reportList.innerHTML = '';

      let q = query(collection(db, "medicalReports"), where("userId", "==", userId), orderBy("timestamp", "desc"));

      const doctorFilter = document.getElementById('filterDoctor').value;
      const dateFilter = document.getElementById('filterDate').value;
      const typeFilter = document.getElementById('filterType').value;

      let querySnapshot = await getDocs(q);

      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();

        // Apply client-side filters (since Firestore doesn't support multiple optional filters easily)
        if (doctorFilter && data.doctor !== doctorFilter) return;
        if (dateFilter && data.date !== dateFilter) return;
        if (typeFilter && data.fileType !== typeFilter) return;

        const div = document.createElement('div');
        div.className = 'report-card';
        const thumbnail = data.fileType === "image"
          ? `<img src="${data.fileURL}" class="thumbnail">`
          : `<img src="https://cdn-icons-png.flaticon.com/512/337/337946.png" class="thumbnail">`;

        div.innerHTML = `
          ${thumbnail}
          <input type="text" value="${data.title}" onchange="updateField('${docSnap.id}', 'title', this.value)">
          <textarea onchange="updateField('${docSnap.id}', 'description', this.value)">${data.description}</textarea>
          <p><strong>Doctor:</strong> ${data.doctor}</p>
          <p><strong>Date:</strong> ${data.date}</p>
          <a href="${data.fileURL}" target="_blank">üìÑ View File</a>
          <div class="actions">
            <button onclick="deleteReport('${docSnap.id}', '${data.fileURL}')">Delete</button>
          </div>
        `;
        reportList.appendChild(div);
      });
    }

    // ‚úÖ Update a field
    async function updateField(id, field, value) {
      await updateDoc(doc(db, "medicalReports", id), { [field]: value });
    }

    // ‚úÖ Delete Report
    async function deleteReport(id, fileURL) {
      try {
        const fileRef = ref(storage, fileURL);
        await deleteObject(fileRef).catch(() => console.log("File not found in storage."));
        await deleteDoc(doc(db, "medicalReports", id));
        alert("üóëÔ∏è Report deleted!");
        loadReports();
      } catch (error) {
        console.error(error);
        alert("‚ùå Failed to delete: " + error.message);
      }
    }

    // ‚úÖ Clear filters
    function clearFilters() {
      document.getElementById('filterDoctor').value = '';
      document.getElementById('filterDate').value = '';
      document.getElementById('filterType').value = '';
      loadReports();
    }

    // ‚úÖ Expose functions globally
    window.updateField = updateField;
    window.deleteReport = deleteReport;

  </script>

  <style>
    body { font-family: 'Segoe UI'; background: #f4f6f9; padding: 20px; }
    .container { max-width: 800px; margin: auto; }
    .card, .report-card {
      background: white; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    input, textarea, select {
      width: 100%; margin: 8px 0; padding: 10px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    button { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
    .report-list { display: flex; flex-wrap: wrap; gap: 20px; }
    .report-card { width: 300px; position: relative; }
    .thumbnail { width: 100%; height: 150px; object-fit: cover; border-radius: 5px; }
    .actions button { background: #e74c3c; margin-top: 10px; }
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>ü©∫ Medical History</h2>

    <!-- Upload Form -->
    <div class="card">
      <input type="text" id="title" placeholder="Report Title">
      <textarea id="description" placeholder="Description / Prescription"></textarea>
      <input type="text" id="doctor" placeholder="Doctor Name">
      <input type="date" id="reportDate">
      <input type="file" id="fileInput" />
      <button id="uploadBtn">Upload</button>
    </div>

    <!-- Filters -->
    <div class="filter-bar">
      <input type="text" id="filterDoctor" placeholder="Filter by Doctor">
      <input type="date" id="filterDate">
      <select id="filterType">
        <option value="">All Types</option>
        <option value="image">Images</option>
        <option value="pdf">PDFs</option>
      </select>
      <button id="applyFiltersBtn">Apply Filters</button>
      <button id="clearFiltersBtn">Clear Filters</button>
    </div>

    <!-- Report List -->
    <div class="report-list" id="reportList"></div>
  </div>
</body>
</html>
